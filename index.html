<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bàn tính Soroban + hộp bóng</title>
  <style>
    :root{
      --frame:#d1d5db; --bar:#9ca3af; --upper:#f87171; --lower:#6ee7b7;
      --rod:#9ca3af; --bg:#ffffff; --text:#111827;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; 
      background:#fafafa; color:var(--text);
      display:flex; flex-direction:column; align-items:center; gap:14px; padding:14px;
    }
    .wrap{width:min(1200px,96vw)}
    .panel{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .pill{border:1px solid #374151; padding:8px 12px; border-radius:999px; font-weight:600}
    .btn{cursor:pointer; user-select:none} .btn:hover{filter:brightness(1.08)}
    .value{font-variant-numeric:tabular-nums; font-weight:800; font-size:clamp(20px,4vw,36px)}

    /* Soroban UI */
    .frame{
      position:relative; width:100%; aspect-ratio:20/7;
      border:10px solid var(--frame); border-radius:22px;
      box-shadow:0 12px 40px rgba(0,0,0,.35) inset;
      overflow:hidden; padding:10px 16px;
    }
    .bar{position:absolute; left:0; right:0; top:45%; height:5px; background:linear-gradient(#263143,#0f172a)}
    .rods{position:absolute; inset:12px 16px; display:grid; grid-template-columns:repeat(var(--cols),1fr)}
    .rod{position:relative}
    .rod::before{content:""; position:absolute; top:0; bottom:0; left:50%; width:6px; transform:translateX(-50%); background:linear-gradient(#9aa3b2,#6b7280); border-radius:3px; opacity:.9}
    .bead{
      position:absolute; left:50%; transform:translateX(-50%);
      width:clamp(28px,4.8vw,48px); height:clamp(18px,3vw,34px); 
      border-radius:999px; display:flex; align-items:center; justify-content:center;
      font-weight:700; cursor:pointer; filter:drop-shadow(0 3px 2px rgba(0,0,0,.25));
      transition:top .18s,bottom .18s,transform .18s; user-select:none;
    }
    .upper{background:linear-gradient(#f87171,#ef4444); border:1px solid #dc2626}
    .lower{background:linear-gradient(#34d399,#10b981); border:1px solid #059669}

    .rod[data-upper="0"] .upper{top:5%} .rod[data-upper="1"] .upper{top:32%}
    .rod .lower.l4{bottom:0%} .rod .lower.l3{bottom:calc(1.1 * var(--gap))}
    .rod .lower.l2{bottom:calc(2.2 * var(--gap))} .rod .lower.l1{bottom:calc(3.3 * var(--gap))}
    .rod[data-lower="1"] .lower.l1{bottom:calc(6% + calc(6px + 3.3 * var(--gap)))} 
    .rod[data-lower="2"] .lower.l1{bottom:calc(6% + calc(6px + 3.3 * var(--gap)))} .rod[data-lower="2"] .lower.l2{bottom:calc(6% + calc(6px + 2.2 * var(--gap)))} 
    .rod[data-lower="3"] .lower.l1{bottom:calc(6% + calc(6px + 3.3 * var(--gap)))} .rod[data-lower="3"] .lower.l2{bottom:calc(6% + calc(6px + 2.2 * var(--gap)))} .rod[data-lower="3"] .lower.l3{bottom:calc(6% + calc(6px + 1.1 * var(--gap)))} 
    .rod[data-lower="4"] .lower.l1{bottom:calc(6% + calc(6px + 3.3 * var(--gap)))} .rod[data-lower="4"] .lower.l2{bottom:calc(6% + calc(6px + 2.2 * var(--gap)))} .rod[data-lower="4"] .lower.l3{bottom:calc(6% + calc(6px + 1.1 * var(--gap)))} .rod[data-lower="4"] .lower.l4{bottom:calc(6% + 6px)}

    .labels{display:grid; grid-template-columns:repeat(var(--cols),1fr); padding-top:10px; text-align:center; font-size:clamp(10px,2.4vw,14px)}

    /* BALL BOX */
    #ball-box{
      order:3px solid #4b5563;border-radius:10px;background:#f9fafb;
      display:flex;flex-wrap:wrap;align-content:flex-start;gap:3px; padding:4px;margin:16px auto;
      position:relative;overflow:hidden;box-shadow:inset 0 0 10px rgba(0,0,0,.2);
    }
    .ball{
      width:26px;height:26px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #ffdd55, #e6b800);
      animation:drop .35s ease-out forwards;
      display:flex; align-items:center; justify-content:center;
      font-size:14px; font-weight:700; color:#000;
    }
    @keyframes drop{
      0%{transform:scale(.2) translateY(-50px); opacity:0}
      90%{transform:scale(1.1); opacity:1}
      100%{transform:scale(1)}
    }
    @keyframes popout{
      0%{transform:scale(1); opacity:1}
      100%{transform:scale(.4) translateY(-60px); opacity:0}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <div class="pill">Bàn tính <strong>Soroban 1:4</strong> + Hộp bóng</div>
    <div class="value" id="value">0</div>
    <div>
      <button class="pill btn" id="clear">Đặt về 0</button>
      <button class="pill btn" id="random">Ngẫu nhiên</button>
    </div>
  </div>

  <div class="frame" id="frame">
    <div class="bar"></div>
    <div class="rods" id="rods"></div>
  </div>
  <div class="labels" id="labels"></div>
  <div id="ball-box"></div>
</div>

<script>
const COLS = 7;
const state = Array.from({length:COLS},()=>({upper:0, lower:0}));
const rodsEl=document.getElementById("rods");
const labelsEl=document.getElementById("labels");
const valueEl=document.getElementById("value");
const ballBox=document.getElementById("ball-box");
let totalBefore=0;
let ballNumber=1; // <--- bộ đếm số bóng

function computeGap(){
  const rect=document.getElementById("frame").getBoundingClientRect();
  const beadH=Math.max(18,Math.min(34,rect.width*0.03));
  return beadH*1.05;
}

let placeNames=['đơn vị','chục','trăm','nghìn','chục nghìn','trăm nghìn','triệu'].reverse();

function addBall(){
  const ball=document.createElement("div");
  ball.className="ball";
  ball.textContent = ballNumber++; // đặt số lên bóng
  ballBox.appendChild(ball);
}

async function removeBall(){
  const b = document.getElementById("ball-box").lastElementChild;
// alert(`Xóa bóng số ${b?b.textContent:'(không có bóng)'}`);
  if(!b) return;
  // b.remove()
  b.style.animation="popout 10s forwards";
  setTimeout(()=>b.remove(),10000);
  ballNumber--; // giảm số thứ tự cho lần sau
}

function computeTotal(){
  return state.reduce((sum,s,i)=>sum+(s.upper*5+s.lower)*10**i,0);
}

function updateTotal(){
  const digits=state.map(s=>s.upper*5+s.lower).reverse();
  let out=digits.join("").replace(/^0+(\d)/,'$1');
  if(/^0+$/.test(out)) out='0';
  valueEl.textContent=out.replace(/\B(?=(\d{3})+(?!\d))/g,'.');
}

function render(){
  const gap=computeGap();
  document.documentElement.style.setProperty('--cols',COLS);
  document.documentElement.style.setProperty('--gap',gap+'px');
  rodsEl.innerHTML='';
  labelsEl.innerHTML='';

  for(let i=COLS-1;i>=0;i--){
    const rod=document.createElement("div");
    rod.className="rod";
    rod.dataset.upper=state[i].upper;
    rod.dataset.lower=state[i].lower;

    const upper=document.createElement("div");
    upper.className="bead upper";
    upper.onclick=()=>clickUpper(i,rod);
    rod.appendChild(upper);

    for(let k=1;k<=4;k++){
      const b=document.createElement("div");
      b.className=`bead lower l${k}`;
      b.onclick=()=>clickLower(i,k,rod);
      rod.appendChild(b);
    }
    rodsEl.appendChild(rod);
    const lb=document.createElement("span");
    lb.textContent=placeNames[COLS-1-i]||'';
    labelsEl.appendChild(lb);
  }

  updateTotal();
  totalBefore=computeTotal();
}

function clickUpper(i,rod){
  const before = computeTotal();
  state[i].upper = state[i].upper?0:1;
  rod.dataset.upper=state[i].upper;
  handleBallsChange(before);
}
function clickLower(i,k,rod){
  const before = computeTotal();
  const c=state[i].lower;
  state[i].lower = (k<=c) ? c-(c-k+1) : ((c===k)?0:k);
  rod.dataset.lower=state[i].lower;
  handleBallsChange(before);
}

async function handleBallsChange(before){
  updateTotal();
  const now = computeTotal();
  // alert(`Giá trị thay đổi từ ${before} thành ${now}`);
  const diff = now - before;
  const absDiff = Math.abs(diff);
  // alert(`Cần thêm/bớt ${absDiff} bóng`);
  if(diff>0) for(let i=0;i<diff;i++) addBall();
  else {
    // for(let i=0;i<absDiff;i++){
    //   alert(`Xóa bóng thứ ${i+1} trong tổng số ${absDiff}`);  
    //   await removeBall();
    // }
    const ball_box = document.getElementById("ball-box");
    if(!ball_box) return;
    // console.log(ball_box.children);
    Promise.all(
      Array.from(ball_box.children).slice(-absDiff).map(b=>{
        return new Promise(resolve=>{
          b.style.animation="popout .35s forwards";
          setTimeout(()=>{
            b.remove();
            ballNumber--;
            resolve();
          },350);
        });
      })
    );
  }
  totalBefore=now;
}

document.getElementById("clear").onclick=()=>{
  state.forEach(s=>{s.upper=0;s.lower=0});
  ballBox.innerHTML="";
  ballNumber = 1; // reset bộ đếm bóng
  render();
};
document.getElementById("random").onclick=()=>{
  state.forEach(s=>{s.upper=Math.random()>.5?1:0;s.lower=Math.floor(Math.random()*5);if(s.upper&&s.lower>4)s.lower=4});
  ballBox.innerHTML="";
  ballNumber=1;
  render();
};

window.onresize=render;
render();
</script>
</body>
</html>
